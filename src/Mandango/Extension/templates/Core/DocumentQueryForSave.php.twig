<?php

    /**
     * Query for save.
     */
    public function queryForSave({% if config_class.isEmbedded %}$query, $isNew, $reset = false{% endif %})
    {
{% if not config_class.isEmbedded %}
{% if config_class.inheritance and 'single' == config_class.inheritance.type %}
        $isNew = $this->isNew();
        $query = parent::queryForSave();
        if ($isNew) {
            $query['{{ config_class.inheritance.field }}'] = '{{ config_class.inheritance.value }}';
        }
        $reset = false;

{% else %}
        $isNew = $this->isNew();
        $query = [];
        $reset = false;

{% endif %}
{% endif %}
{# fields #}
{% if config_class.fields|length %}
        if (isset($this->data['fields'])) {
{# insert #}
            if ($isNew || $reset) {
{% if config_class.isEmbedded %}
                $rootQuery = $query;
                $query =& $rootQuery;
                if (true === $reset) {
                    $path = array('$set', $this->_path);
                } elseif ('deep' == $reset) {
                    $path = explode('.', '$set.'.$this->_path);
                } else {
                    $path = explode('.', $this->_path);
                }
                foreach ($path as $name) {
                    if (0 === strpos($name, '_add')) {
                        $name = substr($name, 4);
                    }
                    if (!isset($query[$name])) {
                        $query[$name] = array();
                    }
                    $query =& $query[$name];
                }
{% endif %}
{% for name, field in config_class.fields %}
{% if field.inherited is not defined or not field.inherited %}
                if (isset($this->data['fields']['{{ name }}'])) {
                    {{ mandango_type_to_mongo(field.type, "$this->data['fields']['" ~ name ~ "']", "$query['" ~ field.dbName ~ "']") }}
                }
{% endif %}
{% endfor %}
{% if config_class.isEmbedded %}
                unset($query);
                $query = $rootQuery;
{% endif %}
{# update #}
            } else {
{% for name, field in config_class.fields %}
{% if field.inherited is not defined or not field.inherited %}
                if (isset($this->data['fields']['{{ name }}']) || array_key_exists('{{ name }}', $this->data['fields'])) {
                    $value = $this->data['fields']['{{ name }}'];
                    $originalValue = $this->getOriginalFieldValue('{{ name }}');
                    if ($value !== $originalValue) {
                        if (null !== $value) {
{% if not config_class.isEmbedded %}
                            {{ mandango_type_to_mongo(field.type, "$this->data['fields']['" ~ name ~ "']", "$query['$set']['" ~ field.dbName ~ "']") }}
{% else %}
                            {{ mandango_type_to_mongo(field.type, "$this->data['fields']['" ~ name ~ "']", "$query['$set'][$this->_path.'." ~ field.dbName ~ "']") }}
{% endif %}
                        } else {
{% if not config_class.isEmbedded %}
                            $query['$unset']['{{ field.dbName }}'] = 1;
{% else %}
                            $query['$unset'][$this->_path.'.{{ field.dbName }}'] = 1;
{% endif %}
                        }
                    }
                }
{% endif %}
{% endfor %}
            }
        }
{% endif %}
        if (true === $reset) {
            $reset = 'deep';
        }
{# embeddeds one #}
{% if config_class.embeddedsOne|length %}
        if (isset($this->data['embeddedsOne'])) {
{% for name, embedded in config_class.embeddedsOne %}
{% if embedded.inherited is not defined or not embedded.inherited %}
            $originalValue = $this->getOriginalEmbeddedOneValue('{{ name }}');
            if (isset($this->data['embeddedsOne']['{{ name }}'])) {
                $resetValue = $reset ? $reset : (!$isNew && $this->data['embeddedsOne']['{{ name }}'] !== $originalValue);
                $query = $this->data['embeddedsOne']['{{ name }}']->queryForSave($query, $isNew, $resetValue);
            } elseif (array_key_exists('{{ name }}', $this->data['embeddedsOne'])) {
                if ($originalValue) {
                    $query['$unset'][$originalValue->_path] = 1;
                }
            }
{% endif %}
{% endfor %}
        }
{% endif %}
{# embeddeds many #}
{% if config_class.embeddedsMany|length %}
        if (isset($this->data['embeddedsMany'])) {
            if ($isNew) {
{% for name, embedded in config_class.embeddedsMany %}
{% if embedded.inherited is not defined or not embedded.inherited %}
                if (isset($this->data['embeddedsMany']['{{ name }}'])) {
                    foreach ($this->data['embeddedsMany']['{{ name }}']->getAdd() as $document) {
                        $query = $document->queryForSave($query, $isNew);
                    }
                }
{% endif %}
{% endfor %}
            } else {
{% for name, embedded in config_class.embeddedsMany %}
{% if embedded.inherited is not defined or not embedded.inherited %}
                if (isset($this->data['embeddedsMany']['{{ name }}'])) {
                    $group = $this->data['embeddedsMany']['{{ name }}'];
                    $mongoType = $group->getMongoType();

                    foreach ($group->getSaved() as $document) {
                        $query = $document->queryForSave($query, $isNew);
                    }

                    $add = null;
                    foreach ($group->getAdd() as $key => $document) {
                        $q = $document->queryForSave(array(), true);
                        foreach (explode('.', $document->_path) as $name) {
                            if (0 === strpos($name, '_add')) {
                                $name = substr($name, 4);
                            }
                            $q = $q[$name];
                        }
                        $add[$key] = $q;
                    }

                    if ($mongoType == \Mandango\Group\AbstractGroup::MONGO_TYPE_ARRAY) {
                        if (null !== $add) {
                            $query['$pushAll'][$group->_path] = $add;
                        }
                    } elseif ($mongoType == \Mandango\Group\AbstractGroup::MONGO_TYPE_OBJECT) {
                        if (!empty($add)) {
                            foreach ($add as $key => $q) {
                                $query['$set'][$group->_path . '.' . $key] = $q;
                            }
                        }
                    } else {
                        throw new \LogicException('The mandango group\'s type is neither an array nor an object. It was: ' . $mongoType);
                    }

                    // Unset a document only if it isn't overwritten by $set
                    foreach ($group->getRemove() as $document) {
                        if (!array_key_exists($document->_path, $query['$set'])) {
                            $query['$unset'][$document->_path] = 1;
                        }
                    }

                }
{% endif %}
{% endfor %}
            }
        }
{% endif %}

        return $query;
    }
